set shell := ["bash", "-lc"]

data_dir := "data"

setup:
    #!/usr/bin/env bash
    set -e
    if ! command -v brew >/dev/null 2>&1; then
        echo "Homebrew is required for local MongoDB on macOS"
        exit 1
    fi

    # Install MongoDB Community Edition via Homebrew
    if ! brew list --formula mongodb-community@8.0 >/dev/null 2>&1; then
        echo "Installing MongoDB Community Edition 8.x..."
        brew tap mongodb/brew
        brew install mongodb-community@8.0
    fi

    # Create local data directory
    mkdir -p {{data_dir}}
    echo "MongoDB setup complete. Use 'just start' to run locally."

start:
    #!/usr/bin/env bash
    set -e

    if ! command -v mongod >/dev/null 2>&1; then
        echo "MongoDB not found. Run 'just setup' first."
        exit 1
    fi

    # Create data directory if it doesn't exist
    mkdir -p {{data_dir}}

    # Start MongoDB with local data directory
    echo "Starting MongoDB on port 27017..."
    echo "Data directory: $(pwd)/{{data_dir}}"
    echo "Connection string: mongodb://localhost:27017/"
    echo ""
    echo "Press Ctrl+C to stop"
    echo ""
    # Use --quiet to reduce startup warnings (optional)
    # Remove --quiet to see all logs for debugging
    mongod --bind_ip 127.0.0.1 --port 27017 --dbpath {{data_dir}}

test:
    @echo "No tests configured for MongoDB add-on"

ha-addon:
    set -e; \
    if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi; \
    ../talos/build/bin/talos addon build mongodb

container-test:
	@echo "==> Container test: mongodb uses Home Assistant's container build system"
	@echo "==> Verifying add-on build completes successfully..."
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon build mongodb
	@echo "==> Add-on build test passed - ready for deployment"

deploy:
    set -e; \
    if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi; \
    ../talos/build/bin/talos addon deploy mongodb
