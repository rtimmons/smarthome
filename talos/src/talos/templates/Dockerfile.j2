# Version pinning based on .nvmrc and .python-version
# Node.js version: {{ addon.node_version }} (from .nvmrc)
# Python version: {{ addon.python_version }} (from .python-version)

{% if addon.python %}
# Use Python {{ addon.python_minor }} base image
FROM python:{{ addon.python_minor }}-alpine

ENV LANG=C.UTF-8
ENV PYTHONUNBUFFERED=1
WORKDIR {{ addon.container_workdir }}

RUN apk add --no-cache \
    bash \
    jq \
    libstdc++ \
    cairo \
    pango \
    gdk-pixbuf \
    ttf-dejavu \
    libjpeg-turbo \
    libwebp \
    lcms2 \
    openjpeg \
    tiff \
    libxcb \
    harfbuzz \
    fribidi \
    zlib \
    freetype \
    libpng \
    libffi \
    libusb \
    pkgconf \
  && apk add --no-cache --virtual .build-deps \
    build-base \
    linux-headers \
    python3-dev \
    cairo-dev \
    pango-dev \
    gdk-pixbuf-dev \
    libjpeg-turbo-dev \
    libwebp-dev \
    lcms2-dev \
    openjpeg-dev \
    tiff-dev \
    libxcb-dev \
    harfbuzz-dev \
    fribidi-dev \
    zlib-dev \
    freetype-dev \
    libpng-dev \
    libffi-dev \
  && python3 -m venv {{ paths.venv }} \
  && {{ paths.venv }}/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

ENV PATH="{{ paths.venv }}/bin:${PATH}"
COPY app/ {{ addon.container_workdir }}/
RUN {{ paths.venv }}/bin/pip install --no-cache-dir {{ addon.container_workdir }}/ \
  && find {{ addon.container_workdir }}/ -type f -name '*.pyc' -delete \
  && find {{ addon.container_workdir }}/ -type d -name '__pycache__' -delete \
  && apk del .build-deps
{% else %}
# Use Node.js {{ addon.node_version }} base image
FROM node:{{ addon.node_version }}-alpine

ENV LANG=C.UTF-8
WORKDIR {{ addon.container_workdir }}

RUN apk add --no-cache bash jq {% if addon.git_clone %}git patch{% endif %}

{% if addon.git_clone %}
COPY app/ {{ paths.tmp_overlay }}/
RUN set -e; \
  for i in 1 2 3 4 5; do \
    git clone {{ addon.git_clone.repo | shquote }} {{ addon.git_clone.target | shquote }} {% if addon.git_clone.ref %}&& cd {{ addon.git_clone.target | shquote }} && git checkout {{ addon.git_clone.ref | shquote }} && cd / {% endif %} \
    && break || { echo "git clone attempt ${i} failed, retrying in 5s..."; rm -rf {{ addon.git_clone.target | shquote }}; sleep 5; }; \
  done; \
  cd {{ addon.git_clone.target | shquote }} \
  && npm install --production \
  && npm cache clean --force \
  && if [ -d {{ paths.tmp_overlay }} ]; then cp -R {{ paths.tmp_overlay }}/. {{ addon.git_clone.target | shquote }}/; fi \
  && if [ -d {{ paths.tmp_overlay }}/patches ]; then for patch in {{ paths.tmp_overlay }}/patches/*.patch; do [ -f "$patch" ] && patch -p1 < "$patch" && echo "Applied patch: $patch"; done; fi
{% else %}
COPY app/ {{ addon.container_workdir }}/
RUN npm ci {% if addon.npm_build %}&& npm run build {% endif %}&& npm cache clean --force
{% endif %}
{% endif %}

COPY run.sh /
RUN chmod a+x /run.sh

{% if addon.port %}EXPOSE {{ addon.port }}{% endif %}

CMD ["/run.sh"]
