#!/bin/bash
# Enhanced remote deployment script template
# Generated by Talos for {{ addon.slug }}

set -euo pipefail

# Configuration
ADDON_SLUG="{{ addon.slug }}"
ADDON_ID="local_{{ addon.slug }}"
DEPLOYMENT_ID="{{ deployment_id }}"
TIMESTAMP="$(date '+%Y-%m-%d %H:%M:%S')"

# Logging functions
log_info() {
    echo "[$TIMESTAMP] INFO: $1"
}

log_error() {
    echo "[$TIMESTAMP] ERROR: $1" >&2
}

log_success() {
    echo "[$TIMESTAMP] SUCCESS: $1"
}

# Error handling
cleanup_on_error() {
    local exit_code=$?
    log_error "Deployment failed with exit code $exit_code"
    
    # Attempt to restore previous state if possible
    if [ -n "${BACKUP_DIR:-}" ] && [ -d "$BACKUP_DIR" ]; then
        log_info "Attempting to restore from backup..."
        # Add restoration logic here if needed
    fi
    
    exit $exit_code
}

trap cleanup_on_error ERR

# Main deployment function
main() {
    log_info "Starting deployment of $ADDON_SLUG (ID: $DEPLOYMENT_ID)"
    
    # Phase 1: Pre-deployment validation
    log_info "Phase 1: Validating system state..."
    validate_system
    
    # Phase 2: Backup current state
    log_info "Phase 2: Creating backup..."
    create_backup
    
    # Phase 3: Deploy addon
    log_info "Phase 3: Deploying addon..."
    deploy_addon
    
    # Phase 4: Post-deployment verification
    log_info "Phase 4: Verifying deployment..."
    verify_deployment
    
    log_success "Deployment of $ADDON_SLUG completed successfully"
}

validate_system() {
    # Check Home Assistant health
    if ! ha core info >/dev/null 2>&1; then
        log_error "Home Assistant core is not responding"
        exit 1
    fi
    
    # Check supervisor health
    if ! ha supervisor info >/dev/null 2>&1; then
        log_error "Home Assistant supervisor is not responding"
        exit 1
    fi
    
    log_info "System validation passed"
}

create_backup() {
    # Create backup directory with timestamp
    BACKUP_DIR="/tmp/addon-backup-$ADDON_SLUG-$(date +%s)"
    mkdir -p "$BACKUP_DIR"
    
    # Backup existing addon if it exists
    if ha addons info "$ADDON_ID" >/dev/null 2>&1; then
        log_info "Backing up existing addon configuration..."
        ha addons info "$ADDON_ID" --raw-json > "$BACKUP_DIR/addon-info.json" || true
    fi
    
    log_info "Backup created at $BACKUP_DIR"
}

deploy_addon() {
    # Stop addon if running
    if ha addons info "$ADDON_ID" >/dev/null 2>&1; then
        log_info "Stopping existing addon..."
        if ! ha addons stop "$ADDON_ID"; then
            log_error "Failed to stop addon $ADDON_ID"
            exit 1
        fi
    fi
    
    # Extract addon files (this would be customized per deployment)
    log_info "Extracting addon files..."
    # Add extraction logic here
    
    # Reload addon list
    log_info "Reloading addon list..."
    if ! ha addons reload; then
        log_error "Failed to reload addon list"
        exit 1
    fi
    
    # Install or rebuild addon
    log_info "Installing/rebuilding addon..."
    if ha addons info "$ADDON_ID" >/dev/null 2>&1; then
        if ! ha addons rebuild "$ADDON_ID"; then
            log_info "Rebuild failed, attempting fresh install..."
            if ! ha addons install "$ADDON_ID"; then
                log_error "Failed to install addon $ADDON_ID"
                exit 1
            fi
        fi
    else
        if ! ha addons install "$ADDON_ID"; then
            log_error "Failed to install addon $ADDON_ID"
            exit 1
        fi
    fi
    
    # Configure addon options
    configure_addon_options
    
    # Start addon
    log_info "Starting addon..."
    if ! ha addons start "$ADDON_ID"; then
        log_error "Failed to start addon $ADDON_ID"
        exit 1
    fi
}

configure_addon_options() {
    # Configure addon options using supervisor API
    local supervisor_token="${SUPERVISOR_TOKEN:-}"
    
    if [ -n "$supervisor_token" ]; then
        log_info "Configuring addon options..."
        
        # Build options JSON
        local options_json='{"watchdog": true'
        {% if addon.ingress %}
        options_json+=', "ingress_panel": true'
        {% endif %}
        {% if addon.port %}
        options_json+=', "network": {"{{ addon.port }}/tcp": {{ addon.port }}}'
        {% endif %}
        options_json+='}'
        
        # Apply options via API
        if curl -sSf -H "Authorization: Bearer $supervisor_token" \
                -H "Content-Type: application/json" \
                -X POST -d "$options_json" \
                "http://supervisor/addons/$ADDON_ID/options" >/dev/null; then
            log_info "Addon options configured successfully"
        else
            log_error "Failed to configure addon options"
            exit 1
        fi
    else
        log_info "SUPERVISOR_TOKEN not available, skipping options configuration"
    fi
}

verify_deployment() {
    # Wait for addon to be fully started
    local max_wait=30
    local wait_count=0
    
    while [ $wait_count -lt $max_wait ]; do
        if ha addons info "$ADDON_ID" --raw-json | jq -e '.state == "started"' >/dev/null 2>&1; then
            log_info "Addon is running"
            break
        fi
        
        sleep 1
        wait_count=$((wait_count + 1))
    done
    
    if [ $wait_count -eq $max_wait ]; then
        log_error "Addon failed to start within $max_wait seconds"
        exit 1
    fi
    
    # Additional health checks can be added here
    {% if addon.ingress %}
    # Check ingress endpoint if applicable
    log_info "Verifying ingress endpoint..."
    # Add ingress health check logic
    {% endif %}
    
    log_info "Deployment verification completed"
}

# Execute main function
main "$@"
