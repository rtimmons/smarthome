# Common Justfile library for smarthome project
# Provides shared variables and helper functions for all addon Justfiles

# ============================================================================
# SETTINGS
# ============================================================================

# Use bash for better error handling and cross-platform compatibility
set shell := ["bash", "-lc"]

# Allow positional arguments for flexibility
set positional-arguments := true

# ============================================================================
# VARIABLES
# ============================================================================

# Repository root detection
repo_root := `git rev-parse --show-toplevel 2>/dev/null || pwd`

# Talos binary path
talos_bin := repo_root + "/talos/build/bin/talos"

# Build directory
build_dir := repo_root + "/build"

# Home Assistant connection settings
ha_host := env_var_or_default("HA_HOST", "homeassistant.local")
ha_port := env_var_or_default("HA_PORT", "22")
ha_user := env_var_or_default("HA_USER", "root")

# ============================================================================
# HELPER FUNCTIONS (Private recipes for use by addon Justfiles)
# ============================================================================

# Check if talos binary exists and build if needed
[private]
ensure-talos:
    @if [ ! -x "{{talos_bin}}" ]; then \
        echo "ğŸ”¨ Building talos..."; \
        {{repo_root}}/talos/build.sh; \
    fi

# Get the current addon name from directory
[private]
addon-name:
    @basename "$(pwd)"

# Validate addon directory structure
[private]
validate-addon:
    @if [ ! -f "config.yaml" ] && [ ! -f "addon.yaml" ]; then \
        echo "âŒ Error: config.yaml or addon.yaml not found. Are you in an addon directory?"; \
        exit 1; \
    fi

# Show addon information
[private]
show-addon-info:
    @echo "ğŸ“¦ Addon: $(just addon-name)"
    @echo "ğŸ“ Directory: $(pwd)"
    @echo "ğŸ  HA Host: {{ha_host}}:{{ha_port}}"
    @echo "ğŸ”§ Talos: {{talos_bin}}"
    @if [ -f "config.yaml" ]; then \
        echo "ğŸ“‹ Config:"; \
        grep -E "^(name|version|description):" config.yaml | sed 's/^/  /'; \
    elif [ -f "addon.yaml" ]; then \
        echo "ğŸ“‹ Config:"; \
        grep -E "^(name|version|description):" addon.yaml | sed 's/^/  /'; \
    fi
