# Snapshot Service Addon Justfile
# Camera snapshot helper service

# Import shared libraries
import "../talos/just/common.just"

# ============================================================================
# ADDON-SPECIFIC VARIABLES
# ============================================================================

# Development port
port := "4010"

# Dependency check helper
ensure_deps := "if [ ! -d 'node_modules' ]; then just setup; fi"

# ============================================================================
# ADDON-SPECIFIC RECIPES
# ============================================================================

# Set up snapshot service development environment
[group: 'setup']
setup:
    @echo "ðŸ”§ Setting up Snapshot Service..."
    @set -e
    @npm install
    @echo "âœ… Snapshot Service setup complete"

# Run development server
[group: 'dev']
dev:
    @echo "ðŸš€ Starting Snapshot Service development server on port {{port}}..."
    @set -e
    @{{ensure_deps}}
    @PORT={{port}} npm run dev

# Run tests
[group: 'test']
test:
    @echo "ðŸ§ª Running Snapshot Service tests..."
    @set -e
    @{{ensure_deps}}
    @npm run test
    @echo "âœ… Tests passed"

# Run linter
[group: 'lint']
lint:
    @echo "ðŸ” Running linter..."
    @set -e
    @{{ensure_deps}}
    @npm run lint

# Format code
[group: 'format']
fmt:
    @echo "âœ¨ Formatting code..."
    @set -e
    @{{ensure_deps}}
    @npm run fmt

# Run type checker
[group: 'lint']
typecheck:
    @echo "ðŸ” Running type checker..."
    @set -e
    @{{ensure_deps}}
    @npm run typecheck

# Build production bundle
[group: 'build']
build:
    @echo "ðŸ—ï¸  Building production bundle..."
    @set -e
    @{{ensure_deps}}
    @npm run build
    @echo "âœ… Build complete"

# ============================================================================
# COMMON ADDON RECIPES (using shared functions)
# ============================================================================

# Build addon using talos
[group: 'build']
ha-addon: ensure-talos validate-addon
    @{{talos_bin}} addon build $(just addon-name)

# Deploy addon using talos
[group: 'deploy']
deploy: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name)

# Deploy addon with verbose output
[group: 'deploy']
deploy-verbose: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --verbose

# Deploy addon in dry-run mode
[group: 'deploy']
deploy-dry-run: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --dry-run

# Test addon container build
[group: 'test']
container-test: ensure-talos validate-addon
    @echo "==> Container test: $(just addon-name) uses Home Assistant's container build system"
    @echo "==> Verifying add-on build completes successfully..."
    @{{talos_bin}} addon build $(just addon-name)
    @echo "==> Add-on build test passed - ready for deployment"

# Show addon information
[group: 'info']
info: validate-addon show-addon-info

# Clean build artifacts
[group: 'clean']
clean:
    @echo "ðŸ§¹ Cleaning build artifacts for $(just addon-name)..."
    @rm -rf "{{build_dir}}/home-assistant-addon/$(just addon-name | tr '-' '_')"
    @rm -rf node_modules/.cache
    @echo "âœ… Clean complete"

# ============================================================================
# ALIASES
# ============================================================================

# Common aliases
alias d := deploy
alias t := test
alias s := setup
