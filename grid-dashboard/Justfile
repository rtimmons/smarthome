import "../talos/just/nvm.just"

set shell := ["bash", "-lc"]
config_env := "XDG_CONFIG_HOME=$PWD/.config"
no_update := "NO_UPDATE_NOTIFIER=1"

setup:
	{{nvm_use}}; \
	cd ExpressServer && npm install

test:
	{{nvm_use}}; \
	cd ExpressServer && mkdir -p .config && {{no_update}} {{config_env}} npm test && {{no_update}} {{config_env}} npm run check

ha-addon:
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon build grid-dashboard

container-test:
	@echo "==> Container test: grid-dashboard uses Home Assistant's container build system"
	@echo "==> Verifying add-on build completes successfully..."
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon build grid-dashboard
	@echo "==> Add-on build test passed - ready for deployment"

deploy:
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon deploy grid-dashboard

report:
	set -e
	scripts/collect_report.sh
