import "../talos/just/nvm.just"

set shell := ["bash", "-lc"]

setup:
	#!/usr/bin/env bash
	set -euo pipefail
	REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || (cd .. && pwd))}"
	if [ ! -x "$REPO_ROOT/talos/build/bin/talos" ]; then
		"$REPO_ROOT/talos/build.sh"
	fi

	echo "Running pre-setup hook..."
	"$REPO_ROOT/talos/build/bin/talos" hook run node-sonos-http-api pre_setup --if-missing-ok

	if [ ! -d node-sonos-http-api ]; then
		echo "Cloning upstream node-sonos-http-api..."
		git clone https://github.com/jishi/node-sonos-http-api.git node-sonos-http-api
	fi

	{{nvm_use}}; \
	cd node-sonos-http-api && npm install

test:
	@echo "No tests defined for node-sonos-http-api; skipping."

ha-addon:
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon build node-sonos-http-api

container-test:
	@echo "==> Container test: node-sonos-http-api uses Home Assistant's container build system"
	@echo "==> Verifying add-on build completes successfully..."
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon build node-sonos-http-api
	@echo "==> Add-on build test passed - ready for deployment"

deploy:
	if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
	../talos/build/bin/talos addon deploy node-sonos-http-api
