# Node Sonos HTTP API Addon Justfile
# Upstream Sonos service with local patches for reliability

# Import shared libraries
import "../talos/just/common.just"
import "../talos/just/nvm.just"

# ============================================================================
# ADDON-SPECIFIC VARIABLES
# ============================================================================

# Upstream repository
upstream_repo := "https://github.com/jishi/node-sonos-http-api.git"
upstream_dir := "node-sonos-http-api"

# ============================================================================
# ADDON-SPECIFIC RECIPES
# ============================================================================

# Set up the node-sonos-http-api development environment
[group: 'setup']
setup:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ”§ Setting up Node Sonos HTTP API..."
    if [ ! -x "{{talos_bin}}" ]; then
        "{{repo_root}}/talos/build.sh"
    fi
    echo "Running pre-setup hook..."
    "{{talos_bin}}" hook run node-sonos-http-api pre_setup --if-missing-ok
    if [ ! -d {{upstream_dir}} ]; then
        echo "Cloning upstream node-sonos-http-api..."
        git clone {{upstream_repo}} {{upstream_dir}}
    fi
    {{nvm_use}}
    cd {{upstream_dir}} && npm install
    echo "âœ… Node Sonos HTTP API setup complete"

# Run tests (currently none defined)
[group: 'test']
test:
    @echo "âš ï¸  No tests defined for node-sonos-http-api; skipping."

# ============================================================================
# COMMON ADDON RECIPES (using shared functions)
# ============================================================================

# Build addon using talos
[group: 'build']
ha-addon: ensure-talos validate-addon
    @{{talos_bin}} addon build $(just addon-name)

# Deploy addon using talos
[group: 'deploy']
deploy: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name)

# Deploy addon with verbose output
[group: 'deploy']
deploy-verbose: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --verbose

# Deploy addon in dry-run mode
[group: 'deploy']
deploy-dry-run: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --dry-run

# Test addon container build
[group: 'test']
container-test: ensure-talos validate-addon
    @echo "==> Container test: $(just addon-name) uses Home Assistant's container build system"
    @echo "==> Verifying add-on build completes successfully..."
    @{{talos_bin}} addon build $(just addon-name)
    @echo "==> Add-on build test passed - ready for deployment"

# Show addon information
[group: 'info']
info: validate-addon show-addon-info

# Clean build artifacts
[group: 'clean']
clean:
    @echo "ðŸ§¹ Cleaning build artifacts for $(just addon-name)..."
    @rm -rf "{{build_dir}}/home-assistant-addon/$(just addon-name | tr '-' '_')"
    @echo "âœ… Clean complete"
