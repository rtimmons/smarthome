---

- name: install dependencies
  become_user: root
  become: true
  apt:
    pkg: [libffi-dev, libssl-dev, python3-nacl, libopenzwave1.5-dev]
    state: present

- name: install master open-zwave configs
  git:
    repo: 'https://github.com/OpenZWave/open-zwave.git'
    dest: /home/pi/open-zwave


- name: install global pip packages
  become_user: root
  become: true
  pip:
    executable: pip3.8
    name:
    - python_openzwave
    - urwid
    - "homeassistant==0.105.0b4"
    # these are packages that home-assistant would normally install "on-demand"
    # but I want to do it ahead of time as much as possible especially since
    # this is the only real way to pass in the -j4 flag.
    - "aiohttp_cors==0.7.0"
    - "aiounifi==11"
    - "colorlog==4.0.2"
    - "defusedxml==0.6.0"
    - "distro==1.4.0"
    - "gTTS-token==1.1.3"
    - "HAP-python==2.6.0"
    - "hass-nabucasa==0.31"
    - "homeassistant-pyozw==0.1.8"
    - "homekit[IP]==0.15.0"
    - "mutagen==1.43.0"
    - "netdisco==2.6.0"
    - "pyMetno==0.4.6"
    - "PyNaCl==1.3.0"
    - "python-nest==4.1.0"
    - "sqlalchemy==1.3.13"
    state: present
  environment:
    MAKEFLAGS: '-j4'

- name: copy home-assistant systemd unit file
  become_user: root
  become: true
  copy:
    src: home-assistant.service
    dest: /etc/systemd/system/home-assistant.service
    owner: root
    group: root
    mode: 0664

# Must be stopped prior to copying config
# since hass writes its state to disk on shutdown.
- name: stop home-assistant service
  become_user: root
  become: true
  service:
    name: home-assistant
    state: stopped
    enabled: yes

- name: copy HomeAssistantConfig
  synchronize:
      group: no
      checksum: yes
      copy_links: yes
      links: yes
      partial: yes
      perms: no
      recursive: yes
      times: no
      # â†“ must be no because don't want to delete hass's internal dbs/logs/deps
      delete: no
      src: "{{ playbook_dir }}/../HomeAssistantConfig/"
      dest: /home/pi/repo/HomeAssistantConfig/

- name: start home-assistant service
  become_user: root
  become: true
  service:
    name: home-assistant
    state: started
    enabled: yes
