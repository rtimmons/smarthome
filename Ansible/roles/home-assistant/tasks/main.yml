---

- name: install dependencies
  become_user: root
  become: true
  apt:
    pkg:
    - python3.11
    - python3.11-dev
    - python3.11-venv
    - python3-pip
    - bluez
    - libffi-dev
    - libssl-dev
    - libjpeg-dev
    - zlib1g-dev
    - autoconf
    - build-essential
    - libopenjp2-7
    - libtiff5
    - libturbojpeg0-dev
    - tzdata
    - ffmpeg
    - liblapack3
    - liblapack-dev
    - libatlas-base-dev
    state: present

# Must be stopped prior to copying config
# since hass writes its state to disk on shutdown.
- name: stop home-assistant service
  become_user: root
  become: true
  service:
    name: home-assistant
    state: stopped
    enabled: yes
  ignore_errors: yes  # The first time we run the service won't exist. Could set vars or something?

- name: install global pip packages
  become_user: root
  become: true
  async: 3600 # 1 hour
  poll: 10
  pip:
    executable: pip3.11
    name:
    - "homeassistant==2023.8.1"
    state: present
  environment:
    MAKEFLAGS: '-j4'

- name: copy home-assistant systemd unit file
  become_user: root
  become: true
  copy:
    src: home-assistant.service
    dest: /etc/systemd/system/home-assistant.service
    owner: root
    group: root
    mode: 0664

- name: create homeassistant
  become_user: root
  become: true
  user:
    name: homeassistant
    comment: "Home Assistant"
    system: yes
    shell: "/sbin/nologin"

- name: create directory
  become_user: root
  become: true
  file:
    path: /srv/homeassistant/repo//HomeAssistantConfig/
    state: directory
    mode: 02775
    owner: homeassistant
    group: homeassistant

- name: Remove .storage dir
  become_user: root
  become: true
  file:
    path: /srv/homeassistant/repo/HomeAssistantConfig/.storage
    state: absent

- name: copy HomeAssistantConfig
  become_user: root
  become: true
  synchronize:
      group: no
      checksum: yes
      copy_links: yes
      links: yes
      partial: yes
      perms: no
      recursive: yes
      times: no
      # â†“ must be no because don't want to delete hass's internal dbs/logs/deps
      delete: no
      src: "{{ playbook_dir }}/../HomeAssistantConfig/"
      dest: /srv/homeassistant/repo//HomeAssistantConfig/
      rsync_opts:
      - "--exclude=venv"
      - "--exclude=deps"

- name: Recursively change ownership of a directory
  become_user: root
  become: true
  ansible.builtin.file:
    path: /srv/homeassistant
    state: directory
    recurse: yes
    owner: homeassistant
    group: homeassistant

- name: start home-assistant service
  become_user: root
  become: true
  service:
    name: home-assistant
    state: started
    enabled: yes
