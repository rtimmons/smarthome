---

- name: Install prerequisites
  become_user: root
  become: yes
  apt:
    name: [curl, ca-certificates, gnupg]
    state: present
    update_cache: yes

- name: Check if Node.js is already installed
  command: node --version
  register: node_version
  ignore_errors: yes
  changed_when: false

- name: Download NodeSource setup script
  become_user: root
  become: yes
  get_url:
    url: https://deb.nodesource.com/setup_20.x
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: node_version.rc != 0 or not node_version.stdout is search("v20")

- name: Run NodeSource setup script
  become_user: root
  become: yes
  command: bash /tmp/nodesource_setup.sh
  when: node_version.rc != 0 or not node_version.stdout is search("v20")

- name: Install Node.js and build tools
  become_user: root
  become: yes
  apt:
    name: [build-essential, nodejs]
    state: present
    update_cache: yes

- name: Clean up setup script
  become_user: root
  become: yes
  file:
    path: /tmp/nodesource_setup.sh
    state: absent

