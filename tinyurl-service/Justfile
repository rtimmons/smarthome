# TinyURL Service Addon Justfile
# URL shortener service backed by MongoDB

# Import shared libraries
import "../talos/just/common.just"
import "../talos/just/nvm.just"

# ============================================================================
# ADDON-SPECIFIC VARIABLES
# ============================================================================

# Development configuration
config_env := "XDG_CONFIG_HOME=$PWD/.config"
no_update := "NO_UPDATE_NOTIFIER=1"
port := "4100"
ensure_deps := "if [ ! -x node_modules/.bin/tsc ]; then npm install --include=dev; fi"

# ============================================================================
# ADDON-SPECIFIC RECIPES
# ============================================================================

# Set up TinyURL service development environment
[group: 'setup']
setup:
    @echo "ðŸ”§ Setting up TinyURL Service..."
    @{{nvm_use}}
    @npm install --include=dev
    @echo "âœ… TinyURL Service setup complete"

# Run development server
[group: 'dev']
dev:
    @echo "ðŸš€ Starting TinyURL Service development server on port {{port}}..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @PORT={{port}} npm run dev

# Run comprehensive tests
[group: 'test']
test:
    @echo "ðŸ§ª Running TinyURL Service tests..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @{{no_update}} {{config_env}} npm run check
    @echo "âœ… Tests passed"

# Run linter
[group: 'lint']
lint:
    @echo "ðŸ” Running linter..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @{{no_update}} {{config_env}} npm run lint

# Format code
[group: 'format']
fmt:
    @echo "âœ¨ Formatting code..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @{{no_update}} {{config_env}} npm run fmt

# Run type checker
[group: 'lint']
typecheck:
    @echo "ðŸ” Running type checker..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @{{no_update}} {{config_env}} npm run typecheck

# Run all checks (lint + typecheck + test)
[group: 'test']
check:
    @echo "ðŸ” Running all checks..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @{{no_update}} {{config_env}} npm run check

# Build production bundle
[group: 'build']
build:
    @echo "ðŸ—ï¸  Building production bundle..."
    @{{nvm_use}}
    @{{ensure_deps}}
    @npm run build
    @echo "âœ… Build complete"

# Run container locally for testing
[group: 'dev']
container-run:
    @echo "ðŸ³ Building and running TinyURL Service container locally..."
    @echo "==> Building add-on image locally"
    @if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi
    @../talos/build/bin/talos addon build tinyurl-service
    @echo "==> Starting container with port 4100 mapped (uses podman if available, else docker)"
    @runtime="$(../talos/scripts/container_runtime.sh cmd)"; \
    if [ -z "$runtime" ]; then echo "No container runtime found (podman or docker required)"; exit 1; fi; \
    tag="tinyurl-service-dev:latest"; \
    build_dir="../build/home-assistant-addon/tinyurl_service"; \
    if [ ! -d "$build_dir" ]; then echo "Build directory not found at $$build_dir"; exit 1; fi; \
    "$runtime" build -t "$tag" "$build_dir"; \
    "$runtime" rm -f tinyurl-service-dev >/dev/null 2>&1 || true; \
    "$runtime" run --name tinyurl-service-dev --rm -p 4100:4100 \
        -e PORT=4100 \
        -e HOST=0.0.0.0 \
        -e MONGODB_URL="mongodb://localhost:27017/tinyurl" \
        "$tag"

# ============================================================================
# COMMON ADDON RECIPES (using shared functions)
# ============================================================================

# Build addon using talos
[group: 'build']
ha-addon: ensure-talos validate-addon
    @{{talos_bin}} addon build $(just addon-name)

# Deploy addon using talos
[group: 'deploy']
deploy: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name)

# Deploy addon with verbose output
[group: 'deploy']
deploy-verbose: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --verbose

# Deploy addon in dry-run mode
[group: 'deploy']
deploy-dry-run: ensure-talos validate-addon
    @{{talos_bin}} addon deploy $(just addon-name) --dry-run

# Test addon container build
[group: 'test']
container-test: ensure-talos validate-addon
    @echo "==> Container test: $(just addon-name) uses Home Assistant's container build system"
    @echo "==> Verifying add-on build completes successfully..."
    @{{talos_bin}} addon build $(just addon-name)
    @echo "==> Add-on build test passed - ready for deployment"

# Show addon information
[group: 'info']
info: validate-addon show-addon-info

# Clean build artifacts
[group: 'clean']
clean:
    @echo "ðŸ§¹ Cleaning build artifacts for $(just addon-name)..."
    @rm -rf "{{build_dir}}/home-assistant-addon/$(just addon-name | tr '-' '_')"
    @rm -rf node_modules/.cache
    @echo "âœ… Clean complete"

# ============================================================================
# ALIASES
# ============================================================================

# Common aliases
alias d := deploy
alias t := test
alias s := setup
alias c := check
