{% extends "base.html" %}

{% block form_heading %}
Best By Label
{% endblock %}

{% block form_fields %}
    <style>
        .bb-help {
            color: var(--muted-color);
        }
    </style>
    {% set text_seed = (initial_query.get('text') or initial_query.get('Text') or '') | string | trim %}
    {% set text_mode = text_seed | length > 0 %}
    {% set base_date_value = (initial_query.get('BaseDate') or initial_query.get('baseDate') or '') | string %}
    {% set has_forced_base_date = base_date_value | length > 0 %}
    {% set delta_value = (initial_query.get('Offset') or initial_query.get('offset') or initial_query.get('Delta') or initial_query.get('delta') or form_context.delta_default) | string %}
    {% set prefix_value = (initial_query.get('Prefix') or initial_query.get('prefix') or form_context.prefix_default) | string %}
    {% set has_custom_prefix = prefix_value != form_context.prefix_default %}

    {% if text_mode %}
        <p class="bb-help">Create a Best By label from a plain text payload. The QR label will trigger this text print.</p>
        <label for="textValue">
            Label text
            <input type="text" id="textValue" name="Text" value="{{ text_seed }}" placeholder="Best By 2025-12-01">
            <small><code>?text=A+B+C</code> becomes <strong>A B C</strong> on the label.</small>
        </label>
        <p class="bb-help"><a href="{{ url_for('bb_route', tpl=active_template.slug) }}">Switch to date-offset mode</a></p>
    {% else %}
        <p class="bb-help">Generate and print a Best By label offset from a chosen base date. Use <code>?baseDate</code> and <code>?offset</code> query params to prefill.</p>
        <label for="useBaseDate" style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="useBaseDate" style="width: auto; margin: 0;" {% if has_forced_base_date %}checked{% endif %}>
            <span>Force base date</span>
        </label>
        <label for="baseDate" id="baseDateLabel" style="{% if not has_forced_base_date %}display: none;{% endif %}">
            Base date (YYYY-MM-DD)
            <input type="date" id="baseDate" name="BaseDate" value="{{ base_date_value }}" placeholder="{{ form_context.base_date_default }}" {% if not has_forced_base_date %}disabled{% endif %}>
            <small>Defaults to today's date when not forced.</small>
        </label>
        <label for="delta">
            Offset (days, weeks, months, or years)
            <input type="text" id="delta" name="Offset" value="{{ delta_value }}" placeholder="2 weeks">
            <small>Example values: <code>2 weeks</code>, <code>10 days</code>, or <code>1 month</code>. Defaults to 2 weeks.</small>
        </label>
        <label for="useCustomPrefix" style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="useCustomPrefix" style="width: auto; margin: 0;" {% if has_custom_prefix %}checked{% endif %}>
            <span>Use custom prefix</span>
        </label>
        <label for="prefix" id="prefixLabel" style="{% if not has_custom_prefix %}display: none;{% endif %}">
            Label prefix
            <input type="text" id="prefix" name="Prefix" value="{{ prefix_value }}" placeholder="Best By: " {% if not has_custom_prefix %}disabled{% endif %}>
            <small>Text before the date. Examples: <code>Best By: </code>, <code>Made </code>, <code>Expires: </code>. Leave empty for no prefix.</small>
        </label>
        <p class="bb-help">Best By date: <strong id="bestByDateValue">{{ form_context.base_date_default }}</strong>. Previews print directly; labels are not stored.</p>
    {% endif %}
{% endblock %}

{% block form_actions %}
    {{ super() }}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const useCustomPrefixCheckbox = document.getElementById('useCustomPrefix');
    const useBaseDateCheckbox = document.getElementById('useBaseDate');
    const prefixInput = document.getElementById('prefix');
    const prefixLabel = document.getElementById('prefixLabel');
    const textInput = document.getElementById('textValue');
    const baseInput = document.getElementById('baseDate');
    const baseLabel = document.getElementById('baseDateLabel');
    const deltaInput = document.getElementById('delta');
    const defaultPrefix = '{{ form_context.prefix_default }}';
    const todayIso = '{{ form_context.base_date_default }}';
    const defaultDelta = '{{ form_context.delta_default }}';

    function updatePrefixFieldVisibility() {
        if (!useCustomPrefixCheckbox || !prefixLabel || !prefixInput) return;
        const isCustom = useCustomPrefixCheckbox.checked;
        if (isCustom) {
            prefixLabel.style.display = 'grid';
            prefixInput.disabled = false;
        } else {
            prefixLabel.style.display = 'none';
            prefixInput.disabled = true;
            prefixInput.value = defaultPrefix;
        }
    }

    if (useCustomPrefixCheckbox) {
        updatePrefixFieldVisibility();
        useCustomPrefixCheckbox.addEventListener('change', updatePrefixFieldVisibility);
    }

    function updateBaseDateFieldVisibility() {
        if (!useBaseDateCheckbox || !baseInput || !baseLabel) return;
        const isForced = useBaseDateCheckbox.checked;
        if (isForced) {
            baseLabel.style.display = 'grid';
            baseInput.disabled = false;
            if (!baseInput.value) {
                baseInput.value = todayIso;
            }
        } else {
            baseLabel.style.display = 'none';
            baseInput.disabled = true;
        }
    }

    if (useBaseDateCheckbox) {
        updateBaseDateFieldVisibility();
        useBaseDateCheckbox.addEventListener('change', updateBaseDateFieldVisibility);
    }

    if (deltaInput && !deltaInput.value) {
        deltaInput.value = defaultDelta;
    }

    const form = document.getElementById('labelForm');
    if (form && textInput) {
        form.addEventListener('submit', () => {
            textInput.value = textInput.value.split(/\s+/).join(' ').trim();
        });
    }
});
</script>
{% endblock %}
