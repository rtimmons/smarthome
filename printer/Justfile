set shell := ["bash", "-lc"]

venv := ".venv"
python := ".venv/bin/python"

ensure-venv:
    set -e
    if [ ! -d "{{venv}}" ]; then python3 -m venv "{{venv}}"; fi

setup:
    @REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"; \
    bash "$REPO_ROOT/printer/scripts/setup.sh"

start:
    set -e; \
    brew_prefix="$(brew --prefix)"; \
    brew_lib="${brew_prefix}/lib"; \
    export LABEL_OUTPUT_DIR="${LABEL_OUTPUT_DIR:-label-output}"; \
    export PRINTER_BACKEND="${PRINTER_BACKEND:-brother-network}"; \
    export DYLD_LIBRARY_PATH="${brew_lib}:${DYLD_LIBRARY_PATH:-}"; \
    export DYLD_FALLBACK_LIBRARY_PATH="${brew_lib}:${DYLD_FALLBACK_LIBRARY_PATH:-}"; \
    export PKG_CONFIG_PATH="${brew_prefix}/lib/pkgconfig:${brew_prefix}/share/pkgconfig:${PKG_CONFIG_PATH:-}"; \
    export PRINTER_DEV_RELOAD="${PRINTER_DEV_RELOAD:-1}"; \
    if [ ! -d "{{venv}}" ]; then just setup; fi; \
    "{{python}}" -m printer_service.app

test:
    set -e
    if [ ! -d "{{venv}}" ]; then just setup; fi
    "{{python}}" -m ruff format --check .
    "{{python}}" -m mypy --config-file mypy.toml src/printer_service tests
    "{{python}}" -m pytest

fmt:
    set -e
    if [ ! -d "{{venv}}" ]; then just setup; fi
    "{{python}}" -m ruff format .

build:
    set -euo pipefail; \
    REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"; \
    talos_bin="$REPO_ROOT/talos/build/bin/talos"; \
    if [ ! -x "$talos_bin" ]; then "$REPO_ROOT/talos/build.sh"; fi; \
    "$talos_bin" addon build printer; \
    addon_dir="$REPO_ROOT/build/home-assistant-addon/printer_service"; \
    if [ ! -d "$addon_dir" ]; then \
        echo "Add-on build output missing at $addon_dir" >&2; \
        exit 1; \
    fi; \
    if ! command -v podman >/dev/null 2>&1; then \
        echo "podman is required to build the printer add-on image" >&2; \
        exit 1; \
    fi; \
    if [ -n "${PRINTER_DOCKER_PLATFORM:-}" ]; then \
        podman build --platform "${PRINTER_DOCKER_PLATFORM}" -t printer-service:local "$addon_dir"; \
    else \
        podman build -t printer-service:local "$addon_dir"; \
    fi

ha-addon:
    set -e; \
    if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi; \
    ../talos/build/bin/talos addon build printer

deploy:
    set -e; \
    if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi; \
    ../talos/build/bin/talos addon deploy printer

report:
    set -e
    scripts/diagnose_ha_addon.sh
