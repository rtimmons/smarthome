# Printer Service Addon Justfile
# Label printer service with Brother network printer support and visual regression testing

# Import shared libraries
import "../talos/just/common.just"
import "../talos/just/python.just"

# ============================================================================
# ADDON-SPECIFIC VARIABLES
# ============================================================================

# Python environment
venv := ".venv"
python := ".venv/bin/python"

# ============================================================================
# ADDON-SPECIFIC RECIPES
# ============================================================================

# Ensure virtual environment exists
[private]
ensure-venv:
    @set -e
    @if [ ! -d "{{venv}}" ]; then python3 -m venv "{{venv}}"; fi

# Set up the printer development environment
[group: 'setup']
setup-printer:
    @echo "ğŸ”§ Setting up Printer Service..."
    @REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"; \
    bash "$REPO_ROOT/printer/scripts/setup.sh"
    @echo "âœ… Printer Service setup complete"

# Start the printer service in development mode
[group: 'dev']
start:
    @echo "ğŸš€ Starting Printer Service..."
    @set -e; \
    brew_prefix="$(brew --prefix)"; \
    brew_lib="${brew_prefix}/lib"; \
    export LABEL_OUTPUT_DIR="${LABEL_OUTPUT_DIR:-label-output}"; \
    export PRINTER_BACKEND="${PRINTER_BACKEND:-brother-network}"; \
    export DYLD_LIBRARY_PATH="${brew_lib}:${DYLD_LIBRARY_PATH:-}"; \
    export DYLD_FALLBACK_LIBRARY_PATH="${brew_lib}:${DYLD_FALLBACK_LIBRARY_PATH:-}"; \
    export PKG_CONFIG_PATH="${brew_prefix}/lib/pkgconfig:${brew_prefix}/share/pkgconfig:${PKG_CONFIG_PATH:-}"; \
    export PRINTER_DEV_RELOAD="${PRINTER_DEV_RELOAD:-1}"; \
    if [ ! -d "{{venv}}" ]; then just setup-printer; fi; \
    "{{python}}" -m printer_service.app

# Run comprehensive tests (linting, type checking, unit tests)
[group: 'test']
test:
    @echo "ğŸ§ª Running Printer Service tests..."
    @set -e
    @if [ ! -d "{{venv}}" ]; then just setup-printer; fi
    @"{{python}}" -m ruff format --check .
    @"{{python}}" -m mypy --config-file mypy.toml src/printer_service tests
    @"{{python}}" -m pytest
    @echo "âœ… All tests passed"

# Format code with ruff
[group: 'format']
fmt:
    @echo "âœ¨ Formatting code..."
    @set -e
    @if [ ! -d "{{venv}}" ]; then just setup-printer; fi
    @"{{python}}" -m ruff format .
    @echo "âœ… Code formatted"

# Build printer service container locally
[group: 'build']
build:
    @echo "ğŸ—ï¸  Building Printer Service container..."
    @set -euo pipefail; \
    REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"; \
    talos_bin="$REPO_ROOT/talos/build/bin/talos"; \
    if [ ! -x "$talos_bin" ]; then "$REPO_ROOT/talos/build.sh"; fi; \
    "$talos_bin" addon build printer; \
    addon_dir="$REPO_ROOT/build/home-assistant-addon/printer_service"; \
    if [ ! -d "$addon_dir" ]; then \
        echo "Add-on build output missing at $addon_dir" >&2; \
        exit 1; \
    fi; \
    container_runtime_script="$REPO_ROOT/talos/scripts/container_runtime.sh"; \
    if [ ! -x "$container_runtime_script" ]; then \
        echo "Container runtime script not found: $container_runtime_script" >&2; \
        exit 1; \
    fi; \
    if [ -n "${PRINTER_DOCKER_PLATFORM:-}" ]; then \
        "$container_runtime_script" build printer-service:local "$addon_dir" "${PRINTER_DOCKER_PLATFORM}"; \
    else \
        "$container_runtime_script" build printer-service:local "$addon_dir"; \
    fi
    @echo "âœ… Container build complete"

# Build addon using talos (legacy alias)
[group: 'build']
ha-addon:
    @set -e; \
    if [ ! -x "../talos/build/bin/talos" ]; then ../talos/build.sh; fi; \
    ../talos/build/bin/talos addon build printer

# Test container build and functionality
[group: 'test']
container-test:
    @echo "ğŸ³ Testing Printer Service container..."
    @set -euo pipefail; \
    echo "==> Testing container build before deployment..."; \
    REPO_ROOT="${REPO_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"; \
    talos_bin="$REPO_ROOT/talos/build/bin/talos"; \
    if [ ! -x "$talos_bin" ]; then "$REPO_ROOT/talos/build.sh"; fi; \
    "$talos_bin" addon build printer; \
    addon_dir="$REPO_ROOT/build/home-assistant-addon/printer_service"; \
    if [ ! -d "$addon_dir" ]; then \
        echo "Add-on build output missing at $addon_dir" >&2; \
        exit 1; \
    fi; \
    container_runtime_script="$REPO_ROOT/talos/scripts/container_runtime.sh"; \
    if [ ! -x "$container_runtime_script" ]; then \
        echo "Container runtime script not found: $container_runtime_script" >&2; \
        exit 1; \
    fi; \
    echo "==> Building container image for testing..."; \
    if [ -n "${PRINTER_DOCKER_PLATFORM:-}" ]; then \
        "$container_runtime_script" build printer-service:test "$addon_dir" "${PRINTER_DOCKER_PLATFORM}"; \
    else \
        "$container_runtime_script" build printer-service:test "$addon_dir"; \
    fi; \
    echo "==> Testing container can start..."; \
    runtime_cmd=$("$container_runtime_script" cmd); \
    if timeout 30 "$runtime_cmd" run --rm printer-service:test python -c "import printer_service; print('Container test passed')"; then \
        echo "==> Container test passed - ready for deployment"; \
    else \
        echo "==> Container test failed - deployment aborted" >&2; \
        exit 1; \
    fi
    @echo "âœ… Container test passed"

# Generate diagnostic report
[group: 'debug']
report:
    @echo "ğŸ“Š Generating Printer Service diagnostic report..."
    @set -e
    @scripts/diagnose_ha_addon.sh
    @echo "âœ… Diagnostic report generated"

# ============================================================================
# VISUAL REGRESSION TESTING
# ============================================================================

# Visual diff commands for regression testing
[group: 'visual']
visual-diff pattern="":
    @scripts/visual-diff.sh {{pattern}}

[group: 'visual']
visual-diff-all pattern="":
    @scripts/visual-diff.sh --all {{pattern}}

[group: 'visual']
visual-diff-summary pattern="":
    @scripts/visual-diff.sh --summary {{pattern}}

[group: 'visual']
visual-diff-grid pattern="":
    @scripts/visual-diff.sh --grid {{pattern}}

[group: 'visual']
visual-diff-clean pattern="":
    @scripts/visual-diff.sh --clean {{pattern}}

# Generate enhanced visual diff with difference highlighting
[group: 'visual']
visual-diff-enhanced baseline current output:
    @scripts/generate-visual-diff.py "{{baseline}}" "{{current}}" "{{output}}"

# Show help for visual diff commands
visual-diff-help:
    @echo "ğŸ“‹ Visual Diff Commands for Printer Label Testing"
    @echo ""
    @echo "ğŸ” Review Commands:"
    @echo "  just visual-diff [pattern]         - Interactive review of visual differences"
    @echo "  just visual-diff-all [pattern]     - Show all differences non-interactively"
    @echo "  just visual-diff-summary [pattern] - Quick summary of differences"
    @echo "  just visual-diff-grid [pattern]    - Thumbnail grid overview (iTerm2)"
    @echo ""
    @echo "ğŸ¯ Advanced Commands:"
    @echo "  just visual-diff-enhanced <baseline> <current> <output> - Generate enhanced diff"
    @echo ""
    @echo "ğŸ§¹ Cleanup Commands:"
    @echo "  just visual-diff-clean [pattern]  - Remove diff files (with confirmation)"
    @echo ""
    @echo "ğŸ”§ Integration:"
    @echo "  just test-visual                  - Run visual tests and show any diffs"
    @echo "  just test-visual-update           - Run tests and update baselines"
    @echo ""
    @echo "ğŸ’¡ Examples:"
    @echo "  just visual-diff receipt           - Review only receipt-related diffs"
    @echo "  just visual-diff-grid              - Thumbnail overview of all differences"
    @echo "  just visual-diff-summary           - Quick text summary of all differences"
    @echo "  just visual-diff-clean receipt     - Clean only receipt diff files"
    @echo ""
    @echo "â„¹ï¸  Pattern filtering works on any part of the filename (e.g., 'receipt', 'best_by', 'qr')"

# Run visual regression tests and show diffs if any
[group: 'test']
test-visual:
    #!/usr/bin/env bash
    @echo "ğŸ§ª Running visual regression tests..."
    @set -e
    @if [ ! -d "{{venv}}" ]; then just setup-printer; fi
    @if "{{python}}" -m pytest tests/test_visual_regression.py -v; then \
        echo "âœ… All visual tests passed!"; \
    else \
        echo ""; \
        echo "âŒ Visual tests failed. Showing differences..."; \
        scripts/visual-diff.sh --summary; \
    fi

# Run visual tests and update baselines for any failures
[group: 'test']
test-visual-update:
    #!/usr/bin/env bash
    @echo "ğŸ§ª Running visual regression tests with baseline updates..."
    @set -e
    @if [ ! -d "{{venv}}" ]; then just setup-printer; fi
    @"{{python}}" -m pytest tests/test_visual_regression.py --regenerate-baselines -v
    @echo "âœ… Visual tests completed and baselines updated!"
