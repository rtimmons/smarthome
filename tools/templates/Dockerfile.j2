ARG BUILD_FROM=ghcr.io/home-assistant/amd64-base:latest
FROM ${BUILD_FROM}

ENV LANG=C.UTF-8
WORKDIR {{ addon.container_workdir }}

RUN apk add --no-cache nodejs npm {% if addon.git_clone %}git patch{% endif %}

{% if addon.git_clone %}
COPY app/ /tmp/app-overlay/
RUN set -e; \
  for i in 1 2 3 4 5; do \
    git clone {{ addon.git_clone.repo | shquote }} {{ addon.git_clone.target | shquote }} {% if addon.git_clone.ref %}&& cd {{ addon.git_clone.target | shquote }} && git checkout {{ addon.git_clone.ref | shquote }} && cd / {% endif %} \
    && break || { echo "git clone attempt ${i} failed, retrying in 5s..."; rm -rf {{ addon.git_clone.target | shquote }}; sleep 5; }; \
  done; \
  cd {{ addon.git_clone.target | shquote }} \
  && npm install --production \
  && npm cache clean --force \
  && if [ -d /tmp/app-overlay ]; then cp -R /tmp/app-overlay/. {{ addon.git_clone.target | shquote }}/; fi \
  && if [ -d /tmp/app-overlay/patches ]; then for patch in /tmp/app-overlay/patches/*.patch; do [ -f "$patch" ] && patch -p1 < "$patch" && echo "Applied patch: $patch"; done; fi
{% else %}
COPY app/ {{ addon.container_workdir }}/
RUN npm ci {% if addon.npm_build %}&& npm run build {% endif %}&& npm cache clean --force
{% endif %}

COPY run.sh /
RUN chmod a+x /run.sh

{% if addon.port %}EXPOSE {{ addon.port }}{% endif %}

CMD ["/run.sh"]
